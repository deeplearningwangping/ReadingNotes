## 概述
运输层为运行在不同主机上的应用进程之间提供逻辑通信功能。应用进程使用运输层提供的逻辑通信功能彼此发送报文，而无需考虑承载这些报文的物理基础。

运输层和网络层的关系：网络层提供了主机之间的逻辑通信，运输层为在不同主机上的进程之间提供了逻辑通信。运输层协议只在主机起作用，运输层能够提供的服务受制于网络层协议的服务模型。

UDP和TCP的责任是将两个端系统间IP的交付服务扩展到进程之间的交付服务。将主机间交付扩展到进程间交付被称为多路复用和多路分解。

网络协议IP协议提供的是不可靠服务，并不能保证数据的完整性等。UDP同样是一种不可靠服务，但可以提供进程间数据传输和差错检查两种服务。TCP在此基础上提供附加服务：
1. 可靠数据传输，通过流量控制、序号、确认和定时器，TCP可以将两个端系统间不可靠的IP服务转为进程间的可靠数据传输服务
2. 拥塞控制，防止某一条TCP连接用过多流量来淹没主机间的链路。

## 多路复用和多路分解
将运输层报文段中的数据交付到正确的套接字的工作称为多路分解。

在源主机从不同的套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传递到网络层，所有这些工作称为多路复用。

端口号是一个16比特的数，其大小在0-65535之间。0-1023范围的端口号称为周知端口号，受限制的，指它们保留给如HTTP（80）和FTP（21）之类的周知应用层协议来使用。

## UDP（无连接运输）
DNS（域名系统）是运用UDP的一个例子

UDP的优势：
1. 实时性较强，TCP由于其拥塞控制实时性较弱
2. 无需建立连接，没有建立连接的时延，因此DNS运行在UDP上，HTTP运行在TCP上
3. 无连接状态，TCP需要在端系统中维护连接状态，包括接收和发送的缓存、拥塞控制参数以及序号与确认号的参数
4. 分组首部开销小。

UDP报文首部包括4个字段，每个字段2个字节，分别为源端口号，目的端口号，长度，检验和。

## 可靠数据传输原理
- 经完全可靠信道的可靠数据传输 rdt1.0 
    - 有限状态机
    - 有完全可靠的信道，接收方就不需要提供任何反馈信息给发送方
- 经具有比特差错信道的可靠数据传输 rdt2.0 
    - 自动重传请求协议（ARQ，又叫停等协议）
    - 处理比特差错还需三种协议功能： 
        - 差错检测。需要利用额外的比特（组原中海明码、奇偶校验码之类）
        - 接收方反馈。肯定确认ACK（收到了），否定确认NAK（请再传一遍），接收方没收到确认就不能发送（停等协议） 
            -  考虑ACK、NAK分组受损的可能性，在数据分组中添加新字段，分组序号0和1（向前取模）
        - 重传。接收方收到有差错分组时，发送方重传该分组。
- 经具有比特差错的丢包信道的可靠数据传输 rdt3.0（ 比特交替协议） 
    - 发送方负责检测和回复丢包工作，对每一个分组维护一个定时器。如果在一个时间段内没收到ACK，则判定为丢包，重传分组，这也引入了冗余数据分组的可能性（时延很大的情况）

##  TCP
#### 为什么是3次握手？
- 主要是为了防止已经失效的连接请求报文突然又传送到了服务器，从而产生错误连接。
- 改为两次握手可能产生死锁。假设A向B发送请求，B收到请求后发送确认信号。此时如果按照两次握手协议，连接已建立，B开始传输数据。然后如果B的确认信号A没有接受到，A将不能知道B的序列号，将无法接受B的数据。而B在发送数据超时后会重复发送数据，从而死锁。
#### 为什么要客户端要等待2MSL（报文最大生存时间）？

- 保证客户端发送的最后一个ACK报文能够到达服务器。
- 如果客户端直接进入closed状态，而服务端还有数据在网络中，当有一个新连接的端口和服务端端口一样时，那么客户端会认为这些数据是新连接的。

当主机接收到一个TCP报文段，其端口号或源IP地址与该主机上进行中的套接字都不匹配，此时主机会向源发送一个特殊的重置报文段，其RST标志位置1.

## TCP拥塞控制（加性增、乘性减（AIMD）拥塞控制方法）

TCP采用的方法是让每一个发送方根据所感知到的网络拥塞程度来限制其能向连接发送流量的速率。

如何调整发送方的发送速率：在发送方跟踪一个变量，即拥塞窗口（cwnd），其对一个TCP发送方能向网络中发送流量的速率进行了限制（发送方中未被确认的数据量不超过cwnd和rwnd的最小值）。

如何感知拥塞：通过出现超时或3次冗余ACK来确认是否发生拥塞。

TCP发送方能够以更高的速率发送而不会使网络拥塞，有三个原则：
1. 一个丢失的报文段意味拥塞，此时应降低TCP发送方速率（减小cwnd的大小）。
2. 一个确认报文段指示网络正在向接收方交付发送方的报文段，此时可以增加发送方的速率。
3. 带宽探测

TCP拥塞控制算法：
1. 慢启动
2. 拥塞避免
3. 快速恢复



